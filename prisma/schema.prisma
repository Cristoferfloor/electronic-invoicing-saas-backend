// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MAIN MODEL: TENANT (COMPANY)
// ============================================================================
model Tenant {
  id                  String    @id @default(cuid())
  
  // Tax information
  commercialName      String
  legalName           String
  taxId               String    @unique // RUC in Ecuador
  address             String
  phone               String?
  email               String    @unique
  logoUrl             String?
  
  // Plan and Status
  plan                String    @default("FREE")
  isActive            Boolean   @default(true)
  
  // Audit
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relationships
  users               User[]
  clients             Client[]
  products            Product[]
  invoices            Invoice[]
  configuration       BillingConfiguration? // 1 to 1 relationship

  @@map("tenants")
}

// ============================================================================
// BILLING CONFIGURATION (Per Tenant)
// ============================================================================
model BillingConfiguration {
  id                  String    @id @default(cuid())
  tenantId            String    @unique
  
  // SRI Data
  establishment       String    @default("001")
  emissionPoint       String    @default("001")
  currentSequential   Int       @default(1)
  
  // Technical Configuration
  environment         SriEnvironment @default(TEST)
  emissionType        Int            @default(1) // 1=Normal
  
  // Electronic Signature
  electronicSignature String?   // Path to .p12 file
  signaturePassword   String?   // Encrypted password
  
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("billing_configurations")
}

enum SriEnvironment {
  TEST
  PRODUCTION
}

// ============================================================================
// USERS AND SECURITY
// ============================================================================
model User {
  id                  String    @id @default(cuid())
  tenantId            String
  
  firstName           String
  lastName            String
  email               String
  passwordHash        String
  
  role                Role      @default(USER)
  isActive            Boolean   @default(true)
  lastLogin           DateTime?
  
  // Relationships
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  refreshTokens       RefreshToken[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  token       String   @unique
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("refresh_tokens")
}

enum Role {
  ADMIN
  USER
}

// ============================================================================
// CLIENTS
// ============================================================================
model Client {
  id                      String    @id @default(cuid())
  tenantId                String
  
  identityType           IdentityType
  identityNumber         String
  legalName              String
  address                String?
  phone                  String?
  email                  String?
  
  isActive               Boolean   @default(true)
  
  tenant                  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices                Invoice[]
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@index([tenantId])
  @@map("clients")
}

enum IdentityType {
  RUC
  ID_CARD
  PASSPORT
}

// ============================================================================
// PRODUCTS
// ============================================================================
model Product {
  id                  String    @id @default(cuid())
  tenantId            String
  
  code                String
  name                String
  description         String?
  unitPrice           Decimal   @db.Decimal(10, 2)
  
  type                ProductType @default(GOOD)
  applyVat            Boolean     @default(true)
  isActive            Boolean     @default(true)
  
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoiceDetails      InvoiceDetail[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("products")
}

enum ProductType {
  GOOD
  SERVICE
}

// ============================================================================
// INVOICING
// ============================================================================
model Invoice {
  id                      String    @id @default(cuid())
  tenantId                String
  
  // General Data
  sequentialNumber        String    // Format 001-001-000000001
  series                  String    // 001001
  numericSequential       Int       
  
  accessKey               String    @unique
  issueDate               DateTime
  
  // Relationships
  clientId                String
  client                  Client    @relation(fields: [clientId], references: [id])
  
  // Economic Values
  subtotalWithoutVat      Decimal   @db.Decimal(12, 2)
  subtotalWithVat         Decimal   @db.Decimal(12, 2)
  totalDiscount           Decimal   @db.Decimal(12, 2)
  subtotal                Decimal   @db.Decimal(12, 2)
  totalVat                Decimal   @db.Decimal(12, 2)
  total                   Decimal   @db.Decimal(12, 2)
  
  // Status and Control
  status                  InvoiceStatus @default(ISSUED)
  generatedXml            String?       @db.Text
  sriErrorMessage         String?
  
  tenant                  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  details                 InvoiceDetail[]
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@index([tenantId])
  @@index([clientId])
  @@index([issueDate])
  @@map("invoices")
}

model InvoiceDetail {
  id                  String    @id @default(cuid())
  tenantId            String
  invoiceId           String
  productId           String
  
  quantity            Decimal   @db.Decimal(10, 2)
  unitPrice           Decimal   @db.Decimal(10, 2)
  discount            Decimal   @db.Decimal(10, 2) @default(0)
  subtotal            Decimal   @db.Decimal(12, 2)
  
  invoice             Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product             Product   @relation(fields: [productId], references: [id])
  
  createdAt           DateTime  @default(now())
  
  @@index([invoiceId])
  @@map("invoice_details")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  AUTHORIZED
  NOT_AUTHORIZED
  CANCELLED
}
