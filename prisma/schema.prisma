// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MODELO PRINCIPAL: TENANT (EMPRESA)
// ============================================================================
model Tenant {
  id                  String    @id @default(cuid())
  
  // Información fiscal
  nombre_comercial    String
  razon_social        String
  ruc                 String    @unique
  direccion           String
  telefono            String?
  email               String    @unique
  logo_url            String?
  
  // Plan y Estado
  plan                String    @default("FREE")
  estado_activo       Boolean   @default(true)
  
  // Auditoría
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relaciones
  usuarios            Usuario[]
  clientes            Cliente[]
  productos           Producto[]
  facturas            Factura[]
  configuracion       ConfiguracionFacturacion? // Relación 1 a 1

  @@map("tenants")
}

// ============================================================================
// CONFIGURACIÓN DE FACTURACIÓN (Por Tenant)
// ============================================================================
model ConfiguracionFacturacion {
  id                  String    @id @default(cuid())
  tenantId            String    @unique // Solo una config por tenant
  
  // Datos SRI
  establecimiento     String    @default("001") // 3 dígitos
  punto_emision       String    @default("001") // 3 dígitos
  secuencial_actual   Int       @default(1)
  
  // Configuración Técnica
  ambiente            AmbienteSri @default(PRUEBAS)
  tipo_emision        Int       @default(1) // 1=Normal
  
  // Firma Electrónica
  firma_electronica   String?   // Ruta al archivo .p12
  firma_password      String?   // Contraseña encriptada
  
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("configuracion_facturacion")
}

enum AmbienteSri {
  PRUEBAS
  PRODUCCION
}

// ============================================================================
// USUARIOS Y SEGURIDAD
// ============================================================================
model Usuario {
  id                  String    @id @default(cuid())
  tenantId            String
  
  nombre              String
  apellido            String
  email               String
  password_hash       String
  
  rol                 Rol       @default(USUARIO)
  activo              Boolean   @default(true)
  last_login          DateTime?
  
  // Relaciones
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  refreshTokens       RefreshToken[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("usuarios")
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  token       String   @unique
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  usuario     Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("refresh_tokens")
}

enum Rol {
  ADMIN
  USUARIO
}

// ============================================================================
// CLIENTES
// ============================================================================
model Cliente {
  id                      String    @id @default(cuid())
  tenantId                String
  
  tipo_identificacion     TipoIdentificacion
  identificacion          String
  razon_social            String
  direccion               String?
  telefono                String?
  email                   String?
  
  activo                  Boolean   @default(true)
  
  tenant                  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  facturas                Factura[]
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@index([tenantId])
  @@map("clientes")
}

enum TipoIdentificacion {
  RUC
  CEDULA
  PASAPORTE
}

// ============================================================================
// PRODUCTOS
// ============================================================================
model Producto {
  id                  String    @id @default(cuid())
  tenantId            String
  
  codigo              String
  nombre              String
  descripcion         String?
  precio_unitario     Decimal   @db.Decimal(10, 2)
  
  tipo                TipoProducto @default(BIEN)
  aplica_iva          Boolean   @default(true)
  activo              Boolean   @default(true)
  
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  detallesFactura     DetalleFactura[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([tenantId, codigo])
  @@index([tenantId])
  @@map("productos")
}

enum TipoProducto {
  BIEN
  SERVICIO
}

// ============================================================================
// FACTURACIÓN
// ============================================================================
model Factura {
  id                      String    @id @default(cuid())
  tenantId                String
  
  // Datos Generales
  numero_secuencial       String    // Formato 001-001-000000001
  serie                   String    // 001001
  secuencial_numerico     Int       // Para ordenamiento fácil
  
  clave_acceso            String    @unique
  fecha_emision           DateTime
  
  // Relaciones
  clienteId               String
  cliente                 Cliente   @relation(fields: [clienteId], references: [id])
  
  // Valores Económicos
  subtotal_sin_iva        Decimal   @db.Decimal(12, 2)
  subtotal_con_iva        Decimal   @db.Decimal(12, 2)
  total_descuento         Decimal   @db.Decimal(12, 2)
  subtotal                Decimal   @db.Decimal(12, 2)
  total_iva               Decimal   @db.Decimal(12, 2)
  total                   Decimal   @db.Decimal(12, 2)
  
  // Estado y Control
  estado                  EstadoFactura @default(EMITIDA)
  xml_generado            String?   @db.Text
  mensaje_error_sri       String?
  
  tenant                  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  detalles                DetalleFactura[]
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  @@index([tenantId])
  @@index([clienteId])
  @@index([fecha_emision])
  @@map("facturas")
}

model DetalleFactura {
  id                  String    @id @default(cuid())
  tenantId            String
  facturaId           String
  productId           String
  
  cantidad            Decimal   @db.Decimal(10, 2)
  precio_unitario     Decimal   @db.Decimal(10, 2)
  descuento           Decimal   @db.Decimal(10, 2) @default(0)
  subtotal            Decimal   @db.Decimal(12, 2)
  
  factura             Factura   @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  producto            Producto  @relation(fields: [productId], references: [id])
  
  createdAt           DateTime  @default(now())
  
  @@index([facturaId])
  @@map("factura_detalles")
}

enum EstadoFactura {
  BORRADOR
  EMITIDA
  AUTORIZADA
  NO_AUTORIZADA
  ANULADA
}
